{% extends "base.html" %}
{% load static %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
html, body { margin: 0; padding: 0; background-color: #00325A; min-height: 100vh; background-image: linear-gradient(135deg, #002844 0%, #00325A 100%); }
.hexbin-tooltip { position: absolute; background: rgba(0, 50, 90, 0.9); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; padding: 8px; font-size: 12px; pointer-events: none; z-index: 100; max-width: 200px; }
.info-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: bold; cursor: help; margin-left: 6px; transition: all 0.2s ease; }
.info-icon:hover { background-color: rgba(255, 255, 255, 0.3); }
.tooltip { position: absolute; visibility: hidden; max-width: 250px; background-color: rgba(0, 25, 50, 0.95); color: white; border-radius: 6px; padding: 10px; font-size: 12px; line-height: 1.4; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); transition: opacity 0.2s; opacity: 0; }
.tooltip.visible { visibility: visible; opacity: 1; }
.chart-placeholder { height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; border: 1px dashed rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.5); font-size: 14px; padding: 20px; }
</style>
{% endblock %}

{% block body %}
<div class="px-10 py-12 min-h-screen w-full">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow mb-8 backdrop-blur-sm">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-white">Absenteísmo - {{ empresa_ativa.RAZAOSOCIAL }}</h1>
        <div class="text-white/60 text-sm bg-white/5 px-4 py-2 rounded-lg border border-white/10">
          <span class="inline-block mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </span>
          Data atual: {% now "d/m/Y" %}
        </div>
      </div>
    </div>
    
    <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow mb-10 backdrop-blur-sm">
      <form method="get" class="flex flex-wrap gap-4 items-end">
        <div>
          <label class="text-white/70 text-sm">Período</label>
          <select name="periodo" onchange="this.form.submit()" class="bg-[#002844] text-white text-sm rounded px-3 py-1 border border-white/10">
            <option value="semestre" {% if periodo == 'semestre' %}selected{% endif %}>Últimos 6 meses</option>
            <option value="trimestre" {% if periodo == 'trimestre' %}selected{% endif %}>Últimos 3 meses</option>
            <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Últimos 30 dias</option>
          </select>
        </div>
        <div>
          <label class="text-white/70 text-sm">Grupo</label>
          <select name="grupo" onchange="this.form.submit()" class="bg-[#002844] text-white text-sm rounded px-3 py-1 border border-white/10">
            <option value="">Todos</option>
            <option value="F" {% if grupo == 'F' %}selected{% endif %}>F</option>
            <option value="M" {% if grupo == 'M' %}selected{% endif %}>M</option>
            <option value="S" {% if grupo == 'S' %}selected{% endif %}>S</option>
            <option value="T" {% if grupo == 'T' %}selected{% endif %}>T</option>
          </select>
        </div>
        <div>
          <label class="text-white/70 text-sm">Duração</label>
          <select name="tipo_duracao" onchange="this.form.submit()" class="bg-[#002844] text-white text-sm rounded px-3 py-1 border border-white/10">
            <option value="">Todos</option>
            <option value="horas" {% if tipo_duracao == 'horas' %}selected{% endif %}>Horas</option>
            <option value="1-3" {% if tipo_duracao == '1-3' %}selected{% endif %}>1-3 dias</option>
            <option value="4-7" {% if tipo_duracao == '4-7' %}selected{% endif %}>4-7 dias</option>
            <option value="8-14" {% if tipo_duracao == '8-14' %}selected{% endif %}>8-14 dias</option>
            <option value="15+" {% if tipo_duracao == '15+' %}selected{% endif %}>15+ dias</option>
          </select>
        </div>
        <div>
          <label class="text-white/70 text-sm">Setor</label>
          <select name="setor" onchange="this.form.submit()" class="bg-[#002844] text-white text-sm rounded px-3 py-1 border border-white/10">
            <option value="">Todos</option>
            {% for s in setores %}
            <option value="{{ s }}" {% if setor == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Bradford Crítico <span class="info-icon" data-tooltip="Indicador que mede o impacto disruptivo das ausências curtas e frequentes. Valores acima de 500 indicam padrões de absenteísmo altamente prejudiciais à operação, exigindo intervenção imediata da gestão.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ bradford_critico_count }}</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Impacto Financeiro <span class="info-icon" data-tooltip="Representa o custo direto das horas perdidas devido aos afastamentos. Calculado com base no valor/hora médio da empresa, não inclui custos indiretos como perda de produtividade ou substituição de pessoal.">i</span></h3>
        <p class="text-3xl font-bold text-white">R$ {{ impacto_financeiro|floatformat:2 }}</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Taxa de Reincidência <span class="info-icon" data-tooltip="Percentual de colaboradores que apresentaram 2 ou mais atestados no período analisado. Valores altos podem indicar problemas crônicos de saúde na equipe ou possíveis abusos do sistema de afastamento.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ taxa_reincidencia|floatformat:1 }}%</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Taxa de Absenteísmo <span class="info-icon" data-tooltip="Percentual de dias úteis perdidos em relação ao total de dias úteis no período. Valores acima de 3% são considerados preocupantes na maioria dos setores industriais, exigindo análise mais detalhada das causas.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ taxa_absenteismo|floatformat:2 }}%</p>
      </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Total de Funcionários <span class="info-icon" data-tooltip="Número total de colaboradores ativos no período analisado. Serve como base para os cálculos percentuais e de taxas de absenteísmo, permitindo a normalização dos dados para comparações justas.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ total_funcionarios }}</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Total de Atestados <span class="info-icon" data-tooltip="Quantidade absoluta de episódios de afastamento registrados no período. Um mesmo funcionário pode ter múltiplos episódios, impactando significativamente a operação devido às interrupções frequentes.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ total_atestados }}</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Média de Dias por Atestado <span class="info-icon" data-tooltip="Duração média de cada episódio de afastamento. Valores baixos com alta frequência podem indicar absenteísmo de curta duração, que costuma ser mais disruptivo que afastamentos longos e planejados.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ media_dias|floatformat:1 }}</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/10 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-1">Média de Atestados <span class="info-icon" data-tooltip="Número médio de atestados por funcionário no período. Este indicador ajuda a identificar se o absenteísmo está distribuído entre muitos colaboradores ou concentrado em poucos, orientando estratégias de intervenção.">i</span></h3>
        <p class="text-3xl font-bold text-white">{{ media_atestados|floatformat:2 }}</p>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Análise de Padrões por Duração <span class="info-icon" data-tooltip="Este gráfico revela a distribuição dos atestados por tempo de afastamento. Picos em categorias específicas podem indicar tendências a investigar: alta ocorrência de atestados de horas pode sugerir problemas pontuais como consultas médicas, enquanto concentração em 15+ dias pode indicar condições mais graves.">i</span></h3>
        <div id="durationChart" class="h-64"></div>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Distribuição por Dia da Semana <span class="info-icon" data-tooltip="Analisa a frequência de atestados por dia da semana, ajudando a identificar padrões suspeitos. Picos em segundas e sextas-feiras, por exemplo, podem indicar possível abuso do sistema de afastamento para prolongar finais de semana, enquanto distribuição equilibrada sugere ocorrências naturais.">i</span></h3>
        <div id="weekdayChart" class="h-64"></div>
      </div>
    </div>

    <div class="mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Evolução do Absenteísmo por Mês <span class="info-icon" data-tooltip="Mostra a tendência de atestados e dias perdidos ao longo do tempo. Permite identificar padrões sazonais, como aumento de afastamentos em períodos específicos (inverno, fim de ano), ou avaliar o impacto de ações implementadas, como programas de saúde ocupacional ou mudanças na política de atestados.">i</span></h3>
        <div id="evolutionChart" class="h-64"></div>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Absenteísmo por Setor (Top 10) <span class="info-icon" data-tooltip="Identifica os setores mais afetados pelo absenteísmo, tanto em número de ocorrências quanto em dias perdidos. Setores com valores desproporcionalmente altos podem indicar problemas específicos como condições de trabalho inadequadas, liderança ineficaz ou riscos ocupacionais que precisam ser investigados.">i</span></h3>
        <div id="sectorChart" class="h-64"></div>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Absenteísmo por Causa (CID) <span class="info-icon" data-tooltip="Apresenta as principais causas de afastamento conforme a Classificação Internacional de Doenças (CID). Permite direcionar programas de prevenção e saúde ocupacional para as condições mais prevalentes, além de identificar possíveis riscos ocupacionais específicos que estejam causando determinadas patologias.">i</span></h3>
        <div id="cidChart" class="h-64"></div>
      </div>
    </div>

    <div class="mb-10">
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">
          Absenteísmo por Gênero <span class="info-icon" data-tooltip="Compara a distribuição de atestados e dias de afastamento entre os gêneros. Disparidades significativas podem refletir questões específicas como licenças maternidade/paternidade, diferenças nas funções desempenhadas ou fatores culturais/comportamentais relacionados à saúde que afetam cada gênero de forma distinta.">i</span>
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <h4 class="text-sm text-white/70 mb-3 text-center font-medium">Distribuição de Atestados <span class="info-icon" data-tooltip="Mostra a proporção de atestados emitidos para cada gênero. Analise se a distribuição é proporcional ao número de funcionários de cada gênero na empresa. Disparidades podem indicar diferentes comportamentos de busca por assistência médica entre os gêneros ou riscos específicos nas funções desempenhadas.">i</span></h4>
            <div id="genderCountChart" class="h-48"></div>
          </div>
          <div>
            <h4 class="text-sm text-white/70 mb-3 text-center font-medium">Dias Afastados <span class="info-icon" data-tooltip="Apresenta o total de dias de afastamento por gênero. Compare com o gráfico ao lado para identificar se algum gênero tende a ter afastamentos mais longos. Por exemplo, um gênero pode ter menos atestados mas com duração maior, sugerindo condições de saúde mais graves ou crônicas.">i</span></h4>
            <div id="genderDaysChart" class="h-48"></div>
          </div>
        </div>
      </div>
    </div>    
    
    <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow mb-10 backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
      <h3 class="text-sm text-white/70 mb-4">Correlação Idade vs. Patologia (Radar) <span class="info-icon" data-tooltip="Visualiza a distribuição de patologias entre diferentes faixas etárias. O formato radar permite identificar rapidamente quais condições de saúde afetam mais cada grupo etário. Padrões específicos podem guiar programas de prevenção direcionados, como campanhas de conscientização sobre doenças cardiovasculares para faixas etárias mais elevadas ou ergonomia para grupos mais jovens com alta incidência de problemas musculoesqueléticos.">i</span></h3>
      <div id="heatmapChart" class="h-96"></div>
      <div class="text-xs text-white/60 mt-2 text-center">Maiores valores indicam maior frequência na faixa etária</div>
    </div>
    <div class="bg-white/5 border border-white/10 rounded-2xl shadow-xl overflow-hidden mb-10 backdrop-blur-sm">
      <div class="p-6 bg-[#002844]">
        <h2 class="text-xl text-white font-semibold mb-1">Bradford Factor: Impacto Disruptivo <span class="info-icon" data-tooltip="O Bradford Factor é uma fórmula que destaca o impacto negativo de ausências curtas e frequentes (SxSxD, onde S=número de episódios e D=dias totais). Funcionários com índice Bradford elevado causam maior disrupção operacional e merecem atenção especial da gestão, seja para suporte de saúde ou investigação de possíveis abusos.">i</span></h2>
        <p class="text-white/60 text-sm">Os 20 funcionários com maior índice de Bradford</p>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead class="bg-[#002844]">
            <tr>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Matrícula</th>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Nome</th>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Episódios</th>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Dias</th>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Bradford</th>
              <th class="text-left px-6 py-4 text-white/60 text-sm">Risco</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/10">
            {% for b in bradford_detalhado %}
            <tr class="hover:bg-white/5 transition">
              <td class="px-6 py-4 text-white/90">{{ b.MATRICULA_FUNC }}</td>
              <td class="px-6 py-4 text-white/90">{{ b.NOME_FUNCIONARIO }}</td>
              <td class="px-6 py-4 text-white/90">{{ b.episodios }}</td>
              <td class="px-6 py-4 text-white/90">{{ b.total_dias }}</td>
              <td class="px-6 py-4 text-white/90">{{ b.bradford }}</td>
              <td class="px-6 py-4">
                <span class="{% if b.risco == 'ALTO' %}text-red-400{% elif b.risco == 'MÉDIO' %}text-yellow-400{% else %}text-green-400{% endif %} font-bold uppercase">
                  {{ b.risco }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-6 text-white/70">Nenhum registro encontrado.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
      {% for sexo_nome, cids in cids_por_genero.items %}
      <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
        <h3 class="text-sm text-white/70 mb-4">Principais CIDs - {{ sexo_nome }} <span class="info-icon" data-tooltip="Apresenta os 5 grupos patológicos mais frequentes para o gênero {{ sexo_nome }}. A análise por gênero permite identificar condições de saúde específicas que afetam desproporcionalmente cada grupo, possibilitando o desenvolvimento de programas de saúde ocupacional mais direcionados e eficazes.">i</span></h3>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead class="bg-[#002844]">
              <tr>
                <th class="text-left px-4 py-2 text-white/60 text-xs">Grupo Patológico (CID)</th>
                <th class="text-right px-4 py-2 text-white/60 text-xs">Qtde</th>
                <th class="text-right px-4 py-2 text-white/60 text-xs">%</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/10">
              {% for cid in cids %}
              <tr class="hover:bg-white/5 transition">
                <td class="px-4 py-2 text-white/90 text-sm">{{ cid.GRUPO_PATOLOGICO|default:"Não classificado" }}</td>
                <td class="text-right px-4 py-2 text-white/90 text-sm">{{ cid.count }}</td>
                <td class="text-right px-4 py-2 text-white/90 text-sm">{% widthratio cid.count total_atestados 100 %}%</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center py-4 text-white/70 text-xs">Nenhum registro encontrado.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="bg-white/5 border border-white/10 rounded-xl p-5 shadow mb-10 backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
      <h3 class="text-sm text-white/70 mb-4">Distribuição de CIDs por Grupo <span class="info-icon" data-tooltip="Analisa as principais patologias em cada grupo operacional (F, M, S, T). Permite identificar problemas de saúde específicos relacionados às diferentes funções ou ambientes de trabalho. Por exemplo, alta incidência de problemas respiratórios em um determinado grupo pode sugerir exposição a agentes irritantes ou condições inadequadas naquela área.">i</span></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for prefixo, cids in cids_por_prefixo_setor.items %}
        <div class="bg-white/5 rounded-lg p-4 border border-white/10 shadow-lg backdrop-blur-sm hover:bg-white/8 transition-all duration-300">
          <h4 class="font-semibold text-white mb-2">Grupo {{ prefixo }}</h4>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead class="bg-[#002844]">
                <tr>
                  <th class="text-left px-3 py-2 text-white/60 text-xs">CID</th>
                  <th class="text-right px-3 py-2 text-white/60 text-xs">Qtde</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/10">
                {% for cid in cids %}
                <tr class="hover:bg-white/5 transition">
                  <td class="px-3 py-2 text-white/90 text-xs">{{ cid.GRUPO_PATOLOGICO|default:"Não classificado"|truncatechars:20 }}</td>
                  <td class="text-right px-3 py-2 text-white/90 text-xs">{{ cid.count }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2" class="text-center py-3 text-white/70 text-xs">Nenhum registro.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<div id="tooltip" class="tooltip"></div>
<script>
const chartData = JSON.parse('{{ chart_data|safe }}');

const colors = { 
  blue: '#0072BC',
  lightBlue: '#3498db',
  green: '#2ecc71',
  orange: '#e67e22',
  red: '#e74c3c',
  purple: '#9b59b6',
  yellow: '#f1c40f',
  gray: 'rgba(255, 255, 255, 0.3)', 
  text: 'rgba(255, 255, 255, 0.7)' 
};

const commonOptions = {
  chart: {
    fontFamily: 'Inter, sans-serif',
    background: 'transparent',
    toolbar: {
      show: true,
      tools: {
        download: true,
        selection: true,
        zoom: true,
        zoomin: true,
        zoomout: true,
        pan: true,
        reset: true
      },
      export: {
        csv: {
          filename: 'dados-chart',
          columnDelimiter: ',',
          headerCategory: 'categoria',
          headerValue: 'valor'
        },
        svg: {
          filename: 'grafico'
        },
        png: {
          filename: 'grafico'
        }
      },
      autoSelected: 'zoom'
    },
    animations: { enabled: true, easing: 'easeinout', speed: 800 }
  },
  theme: { mode: 'dark' },
  colors: [colors.blue, colors.green, colors.orange, colors.purple, colors.red],
  stroke: { curve: 'smooth', width: 2 },
  grid: {
    borderColor: 'rgba(255, 255, 255, 0.05)',
    strokeDashArray: 3,
    position: 'back'
  },
  xaxis: {
    labels: { style: { colors: colors.text, fontSize: '11px' } },
    axisBorder: { show: false },
    axisTicks: { show: false }
  },
  yaxis: {
    labels: { style: { colors: colors.text, fontSize: '11px' } }
  },
  tooltip: { theme: 'dark' },
  legend: {
    position: 'top',
    horizontalAlign: 'center',
    labels: { colors: colors.text },
    markers: { width: 12, height: 12, strokeWidth: 0, radius: 12 },
    itemMargin: { horizontal: 8, vertical: 0 },
    fontSize: '12px',
    fontFamily: 'Inter, sans-serif'
  },
  responsive: [
    { breakpoint: 640, options: { legend: { position: 'bottom' } } }
  ]
};

const durationOptions = {
  ...commonOptions,
  chart: { ...commonOptions.chart, type: 'bar', height: 250 },
  series: [{ name: 'Quantidade', data: chartData.duracao_patterns.data }],
  xaxis: { ...commonOptions.xaxis, categories: chartData.duracao_patterns.labels },
  plotOptions: { bar: { borderRadius: 4, columnWidth: '70%', distributed: true } },
  legend: { show: false },
  dataLabels: { enabled: false },
  tooltip: {
    enabled: true,
    theme: 'dark',
    shared: false,
    intersect: false,
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const value = series[seriesIndex][dataPointIndex];
      const category = w.globals.labels[dataPointIndex];
      const total = chartData.duracao_patterns.data.reduce((a, b) => a + b, 0);
      const percentage = ((value / total) * 100).toFixed(1);
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-1">${category}</div>
        <div class="text-white/80 mb-1">Quantidade: <span class="font-bold">${value}</span> (${percentage}% do total)</div>
        <div class="text-white/70 text-xs mt-2">
          <p>Analise se há concentração em faixas específicas:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Picos em atestados de horas sugerem questões pontuais</li>
            <li>Muitos afastamentos de 1-3 dias podem indicar problemas recorrentes</li>
            <li>Alta frequência de 15+ dias aponta para condições mais graves</li>
          </ul>
        </div>
      </div>`;
    }
  }
};
new ApexCharts(document.querySelector("#durationChart"), durationOptions).render();

const weekdayOptions = {
  ...commonOptions,
  chart: { ...commonOptions.chart, type: 'bar', height: 250 },
  colors: [colors.lightBlue],
  series: [{ name: 'Quantidade', data: chartData.dia_semana.data }],
  xaxis: { ...commonOptions.xaxis, categories: chartData.dia_semana.labels },
  plotOptions: { bar: { borderRadius: 4, columnWidth: '70%' } },
  legend: { show: false },
  dataLabels: { enabled: false },
  tooltip: {
    enabled: true,
    theme: 'dark',
    shared: false,
    intersect: false,
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const value = series[seriesIndex][dataPointIndex];
      const day = w.globals.labels[dataPointIndex];
      const total = chartData.dia_semana.data.reduce((a, b) => a + b, 0);
      const percentage = ((value / total) * 100).toFixed(1);
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-1">${day}</div>
        <div class="text-white/80 mb-1">Quantidade: <span class="font-bold">${value}</span> (${percentage}% do total)</div>
        <div class="text-white/70 text-xs mt-2">
          <p>Padrões a observar:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Concentração em segundas/sextas sugere possível extensão de finais de semana</li>
            <li>Picos em dias específicos podem indicar fatores operacionais</li>
            <li>Distribuição equilibrada indica ocorrências naturais de saúde</li>
          </ul>
        </div>
      </div>`;
    }
  }
};
new ApexCharts(document.querySelector("#weekdayChart"), weekdayOptions).render();

const evolutionOptions = {
  ...commonOptions,
  chart: { ...commonOptions.chart, type: 'line', height: 250 },
  colors: [colors.blue, colors.orange],
  series: [
    { name: 'Atestados', type: 'area', data: chartData.evolucao_mensal.data_count },
    { name: 'Dias Afastados', type: 'line', data: chartData.evolucao_mensal.data_dias }
  ],
  xaxis: { ...commonOptions.xaxis, categories: chartData.evolucao_mensal.labels },
  fill: {
    type: ['gradient', 'solid'],
    gradient: {
      shade: 'dark', type: "vertical", shadeIntensity: 0.2,
      opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100]
    }
  },
  stroke: { curve: 'smooth', width: [3, 3] },
  markers: { size: 4, strokeWidth: 0, hover: { size: 6 } },
  tooltip: {
    enabled: true,
    theme: 'dark',
    shared: true,
    intersect: false,
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const month = w.globals.labels[dataPointIndex];
      const atestados = series[0][dataPointIndex];
      const dias = series[1][dataPointIndex];
      const mediaAtestado = dias / atestados;
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-2">${month}</div>
        <div class="text-white/80 mb-1">Atestados: <span class="font-bold">${atestados}</span></div>
        <div class="text-white/80 mb-1">Dias Afastados: <span class="font-bold">${dias}</span></div>
        <div class="text-white/80 mb-1">Média Dias/Atestado: <span class="font-bold">${mediaAtestado.toFixed(1)}</span></div>
        <div class="text-white/70 text-xs mt-2">
          <p>Análise de tendências:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Observe padrões sazonais (inverno, férias, etc.)</li>
            <li>Picos podem estar associados a epidemias ou mudanças organizacionais</li>
            <li>Diferenças entre linhas indicam variação na duração média dos atestados</li>
          </ul>
        </div>
      </div>`;
    }
  }
};
new ApexCharts(document.querySelector("#evolutionChart"), evolutionOptions).render();

const sectorOptions = {
  ...commonOptions,
  chart: { ...commonOptions.chart, type: 'bar', height: 250, stacked: false },
  colors: [colors.orange, colors.blue],
  series: [
    { name: 'Dias', data: chartData.absenteismo_por_setor.data_dias },
    { name: 'Quantidade', data: chartData.absenteismo_por_setor.data_count }
  ],
  xaxis: { ...commonOptions.xaxis, categories: chartData.absenteismo_por_setor.labels },
  plotOptions: {
    bar: { horizontal: true, dataLabels: { position: 'top' }, borderRadius: 4, columnWidth: '70%' }
  },
  dataLabels: { enabled: false },
  tooltip: {
    enabled: true,
    theme: 'dark',
    shared: true,
    intersect: false,
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const setor = w.globals.labels[dataPointIndex];
      const dias = series[0][dataPointIndex];
      const quantidade = series[1][dataPointIndex];
      const mediaSetor = dias / quantidade;
      
      const totalDias = chartData.absenteismo_por_setor.data_dias.reduce((a, b) => a + b, 0);
      const totalQtd = chartData.absenteismo_por_setor.data_count.reduce((a, b) => a + b, 0);
      const percDias = ((dias / totalDias) * 100).toFixed(1);
      const percQtd = ((quantidade / totalQtd) * 100).toFixed(1);
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-2">Setor: ${setor}</div>
        <div class="text-white/80 mb-1">Dias Afastados: <span class="font-bold">${dias}</span> (${percDias}% do total)</div>
        <div class="text-white/80 mb-1">Quantidade: <span class="font-bold">${quantidade}</span> (${percQtd}% do total)</div>
        <div class="text-white/80 mb-1">Média Dias/Atestado: <span class="font-bold">${mediaSetor.toFixed(1)}</span></div>
        <div class="text-white/70 text-xs mt-2">
          <p>Análise do setor:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Setores com barras de dias > quantidade têm afastamentos mais longos</li>
            <li>Proporção desequilibrada pode indicar problemas específicos do setor</li>
            <li>Considere fatores como tamanho da equipe, tipo de trabalho e riscos específicos</li>
          </ul>
        </div>
      </div>`;
    }
  }
};
new ApexCharts(document.querySelector("#sectorChart"), sectorOptions).render();

const cidOptions = {
  ...commonOptions,
  chart: { ...commonOptions.chart, type: 'bar', height: 250 },
  colors: [colors.purple, colors.green],
  series: [
    { name: 'Quantidade', data: chartData.absenteismo_por_cid.data_count.map(val => parseInt(val) || 0) },
    { name: 'Dias', data: chartData.absenteismo_por_cid.data_dias.map(val => parseInt(val) || 0) }
  ],
  xaxis: { ...commonOptions.xaxis, categories: chartData.absenteismo_por_cid.labels },
  plotOptions: {
    bar: { horizontal: true, dataLabels: { position: 'top' }, borderRadius: 4, columnWidth: '70%' }
  },
  dataLabels: { enabled: false },
  tooltip: {
    enabled: true,
    theme: 'dark',
    shared: true,
    intersect: false,
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const cid = w.globals.labels[dataPointIndex];
      const quantidade = series[0][dataPointIndex];
      const dias = series[1][dataPointIndex];
      const mediaAtestado = dias / quantidade || 0;
      
      const totalQtd = chartData.absenteismo_por_cid.data_count.reduce((a, b) => a + parseInt(b||0), 0);
      const totalDias = chartData.absenteismo_por_cid.data_dias.reduce((a, b) => a + parseInt(b||0), 0);
      const percQtd = ((quantidade / totalQtd) * 100).toFixed(1);
      const percDias = ((dias / totalDias) * 100).toFixed(1);
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-2">CID: ${cid}</div>
        <div class="text-white/80 mb-1">Quantidade: <span class="font-bold">${quantidade}</span> (${percQtd}% do total)</div>
        <div class="text-white/80 mb-1">Dias Afastados: <span class="font-bold">${dias}</span> (${percDias}% do total)</div>
        <div class="text-white/80 mb-1">Média Dias/Atestado: <span class="font-bold">${mediaAtestado.toFixed(1)}</span></div>
        <div class="text-white/70 text-xs mt-2">
          <p>Informações importantes:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>CIDs com alta frequência podem indicar problemas ambientais ou ocupacionais</li>
            <li>Patologias com média de dias elevada representam condições mais graves</li>
            <li>Identifique oportunidades para programas preventivos específicos</li>
          </ul>
        </div>
      </div>`;
    }
  }
};
new ApexCharts(document.querySelector("#cidChart"), cidOptions).render();

const genderCountChart = {
  chart: { 
    id: 'gender-count-chart',
    type: 'pie', 
    height: 200,
    background: 'transparent',
    toolbar: {
      show: true,
      tools: {
        download: true,
        selection: false,
        zoom: false,
        zoomin: false,
        zoomout: false,
        pan: false,
        reset: false
      },
      export: {
        csv: {
          filename: 'distribuicao-atestados-por-genero',
          columnDelimiter: ',',
          headerCategory: 'Gênero',
          headerValue: 'Atestados'
        },
        svg: {
          filename: 'distribuicao-atestados-por-genero'
        },
        png: {
          filename: 'distribuicao-atestados-por-genero'
        }
      }
    },
    animations: { enabled: true, easing: 'easeinout', speed: 800 }
  },
  colors: ['#3498db', '#9b59b6', 'rgba(149, 165, 166, 0.8)'],
  series: chartData.genero.count,
  labels: chartData.genero.labels,
  theme: { mode: 'dark' },
  legend: {
    position: 'bottom',
    fontSize: '11px',
    fontFamily: 'Inter, sans-serif',
    labels: { colors: colors.text },
    markers: { width: 10, height: 10, radius: 2 }
  },
  tooltip: {
    enabled: true,
    theme: 'dark',
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const label = w.globals.labels[dataPointIndex];
      const value = w.globals.seriesTotals[dataPointIndex];
      const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
      const percentage = ((value / total) * 100).toFixed(1);
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-2">Gênero: ${label}</div>
        <div class="text-white/80 mb-1">Atestados: <span class="font-bold">${Math.round(value)}</span> (${percentage}% do total)</div>
        <div class="text-white/70 text-xs mt-2">
          <p>Análise por gênero:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Compare com a distribuição de gênero na força de trabalho total</li>
            <li>Analise junto ao gráfico de dias para entender duração média</li>
            <li>Considere fatores biológicos e ocupacionais específicos para cada gênero</li>
            <li>Identifique necessidades de programas de saúde direcionados</li>
          </ul>
        </div>
      </div>`;
    }
  },
  responsive: [{
    breakpoint: 480,
    options: { legend: { position: 'bottom' } }
  }]
};
new ApexCharts(document.querySelector("#genderCountChart"), genderCountChart).render();

const genderDaysChart = {
  chart: { 
    id: 'gender-days-chart',
    type: 'pie', 
    height: 200,
    background: 'transparent',
    toolbar: {
      show: true,
      tools: {
        download: true,
        selection: false,
        zoom: false,
        zoomin: false,
        zoomout: false,
        pan: false,
        reset: false
      },
      export: {
        csv: {
          filename: 'dias-afastados-por-genero',
          columnDelimiter: ',',
          headerCategory: 'Gênero',
          headerValue: 'Dias'
        },
        svg: {
          filename: 'dias-afastados-por-genero'
        },
        png: {
          filename: 'dias-afastados-por-genero'
        }
      }
    },
    animations: { enabled: true, easing: 'easeinout', speed: 800 }
  },
  colors: ['#3498db', '#9b59b6', 'rgba(149, 165, 166, 0.8)'],
  series: chartData.genero.dias,
  labels: chartData.genero.labels,
  theme: { mode: 'dark' },
  legend: {
    position: 'bottom',
    fontSize: '11px',
    fontFamily: 'Inter, sans-serif',
    labels: { colors: colors.text },
    markers: { width: 10, height: 10, radius: 2 }
  },
  tooltip: {
    enabled: true,
    theme: 'dark',
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const label = w.globals.labels[dataPointIndex];
      const value = w.globals.seriesTotals[dataPointIndex];
      const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
      const percentage = ((value / total) * 100).toFixed(1);
      
      const atestadosGenero = chartData.genero.count[dataPointIndex];
      const diasGenero = chartData.genero.dias[dataPointIndex];
      const mediaDiasGenero = diasGenero / atestadosGenero;
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg">
        <div class="text-white font-medium mb-2">Gênero: ${label}</div>
        <div class="text-white/80 mb-1">Dias Afastados: <span class="font-bold">${Math.round(value)}</span> (${percentage}% do total)</div>
        <div class="text-white/80 mb-1">Média Dias/Atestado: <span class="font-bold">${mediaDiasGenero.toFixed(1)}</span></div>
        <div class="text-white/70 text-xs mt-2">
          <p>Insights importantes:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Compare com o gráfico de atestados para avaliar duração média por gênero</li>
            <li>Diferenças significativas podem indicar tipos distintos de condições de saúde</li>
            <li>Alta média de dias pode sugerir condições mais graves ou crônicas</li>
            <li>Analise também faixa etária e funções predominantes de cada gênero</li>
          </ul>
        </div>
      </div>`;
    }
  },
  responsive: [{
    breakpoint: 480,
    options: { legend: { position: 'bottom' } }
  }]
};
new ApexCharts(document.querySelector("#genderDaysChart"), genderDaysChart).render();

let radarSeries = [];
let patologias = [];

chartData.age_cid_correlation.data.forEach(item => {
  if (!patologias.includes(item.cid)) {
    patologias.push(item.cid);
  }
});

let faixasEtarias = {};
chartData.age_cid_correlation.data.forEach(item => {
  if (!faixasEtarias[item.age_range]) {
    faixasEtarias[item.age_range] = {};
    patologias.forEach(patologia => {
      faixasEtarias[item.age_range][patologia] = 0;
    });
  }
  faixasEtarias[item.age_range][item.cid] = item.count;
});

for (let faixaEtaria in faixasEtarias) {
  let serieData = [];
  patologias.forEach(patologia => {
    serieData.push(faixasEtarias[faixaEtaria][patologia]);
  });
  
  radarSeries.push({
    name: faixaEtaria,
    data: serieData
  });
}

const radarOptions = {
  chart: { 
    type: 'radar', 
    height: 400,
    background: 'transparent',
    toolbar: {
      show: true,
      tools: {
        download: true,
        selection: true,
        zoom: true,
        zoomin: true,
        zoomout: true,
        pan: true,
        reset: true
      },
      export: {
        csv: {
          filename: 'correlacao-idade-patologia',
          columnDelimiter: ',',
          headerCategory: 'Patologia',
          headerValue: 'Valor'
        },
        svg: {
          filename: 'correlacao-idade-patologia'
        },
        png: {
          filename: 'correlacao-idade-patologia'
        }
      }
    },
    dropShadow: {
      enabled: true,
      blur: 1,
      left: 1,
      top: 1
    }
  },
  series: radarSeries,
  theme: {
    mode: 'dark',
    palette: 'palette1'
  },
  colors: ['#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#e74c3c'],
  labels: patologias,
  stroke: {
    width: 2
  },
  fill: {
    opacity: 0.2
  },
  markers: {
    size: 5,
    hover: {
      size: 8
    }
  },
  title: {
    text: 'Correlação Idade vs. Patologia',
    align: 'center',
    style: { 
      color: colors.text,
      fontSize: '14px' 
    }
  },
  xaxis: {
    labels: { 
      style: { 
        colors: Array(patologias.length).fill(colors.text),
        fontSize: '11px'
      }
    }
  },
  yaxis: {
    labels: {
      formatter: function(val) {
        return Math.round(val);
      },
      style: {
        colors: colors.text
      }
    }
  },
  tooltip: {
    enabled: true,
    theme: 'dark',
    custom: function({series, seriesIndex, dataPointIndex, w}) {
      const faixaEtaria = w.globals.seriesNames[seriesIndex];
      const patologia = w.globals.labels[dataPointIndex];
      const ocorrencias = series[seriesIndex][dataPointIndex];
      
      const totalFaixaEtaria = series[seriesIndex].reduce((a, b) => a + b, 0);
      const percentualPatologia = ((ocorrencias / totalFaixaEtaria) * 100).toFixed(1);
      
      const valoresOutrasFaixas = [];
      for (let i = 0; i < series.length; i++) {
        if (i !== seriesIndex) {
          valoresOutrasFaixas.push({
            faixa: w.globals.seriesNames[i],
            valor: series[i][dataPointIndex]
          });
        }
      }
      
      valoresOutrasFaixas.sort((a, b) => b.valor - a.valor);
      
      let comparativoHTML = '';
      if (valoresOutrasFaixas.length > 0) {
        comparativoHTML = `<div class="text-white/80 mt-2 text-xs">Comparativo com outras faixas etárias:</div>
          <ul class="list-disc ml-4 mt-1 text-xs">`;
        
        valoresOutrasFaixas.forEach(item => {
          comparativoHTML += `<li>${item.faixa}: ${Math.round(item.valor)} ocorrências</li>`;
        });
        
        comparativoHTML += `</ul>`;
      }
      
      return `<div class="p-3 bg-[#002844] rounded border border-white/10 shadow-lg" style="min-width: 220px;">
        <div class="text-white font-medium mb-2">Faixa Etária: ${faixaEtaria}</div>
        <div class="text-white/80 mb-1">Patologia: <span class="font-bold">${patologia}</span></div>
        <div class="text-white/80 mb-1">Ocorrências: <span class="font-bold">${Math.round(ocorrencias)}</span> (${percentualPatologia}% da faixa)</div>
        
        ${comparativoHTML}
        
        <div class="text-white/70 text-xs mt-2">
          <p>Como interpretar:</p>
          <ul class="list-disc ml-4 mt-1">
            <li>Picos indicam maior prevalência da patologia na faixa etária</li>
            <li>Compare padrões entre faixas para identificar tendências</li>
            <li>Use para direcionar programas preventivos específicos</li>
          </ul>
        </div>
      </div>`;
    }
  },
  legend: {
    position: 'bottom',
    horizontalAlign: 'center',
    offsetY: 10,
    itemMargin: {
      horizontal: 8,
      vertical: 5
    },
    labels: {
      colors: colors.text
    }
  },
  responsive: [
    {
      breakpoint: 768,
      options: {
        chart: {
          height: 350
        }
      }
    }
  ]
};
new ApexCharts(document.querySelector("#heatmapChart"), radarOptions).render();

function setupTooltips() {
  const tooltip = document.getElementById('tooltip');
  const infoIcons = document.querySelectorAll('.info-icon');
  infoIcons.forEach(icon => {
    icon.addEventListener('mouseenter', (e) => {
      const tooltipText = e.target.getAttribute('data-tooltip');
      tooltip.textContent = tooltipText;
      const iconRect = e.target.getBoundingClientRect();
      const tooltipWidth = 250;
      let left = iconRect.left + (iconRect.width / 2) - (tooltipWidth / 2);
      const top = iconRect.bottom + 8 + window.scrollY;
      if (left + tooltipWidth > window.innerWidth - 10) { left = window.innerWidth - tooltipWidth - 10; }
      if (left < 10) { left = 10; }
      tooltip.style.left = `${left}px`;
      tooltip.style.top = `${top}px`;
      tooltip.style.maxWidth = `${tooltipWidth}px`;
      tooltip.classList.add('visible');
    });
    icon.addEventListener('mouseleave', () => { tooltip.classList.remove('visible'); });
  });
}

document.addEventListener('DOMContentLoaded', function() {
  setupTooltips();
});
</script>
{% endblock %}